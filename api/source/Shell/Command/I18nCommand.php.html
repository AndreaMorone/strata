<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
namespace Strata\Shell\Command;

use Strata\Strata;
use Strata\Utility\Hash;
use Strata\I18n\i18n;
use Strata\I18n\WpCode;
use Strata\I18n\Locale;

use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Input\InputDefinition;
use Symfony\Component\Console\Output\OutputInterface;

use Gettext\Translations;
use RecursiveDirectoryIterator;
use RecursiveIteratorIterator;

class I18nCommand extends StrataCommand
{
    /**
     * {@inheritdoc}
     */
    protected function configure()
    {
        $this
            -&gt;setName('i18n')
            -&gt;setDescription('Translates the current application\'s source code and themes.')
            -&gt;addArgument(
                'type',
                InputArgument::REQUIRED,
                'One of the following: extract.'
            );
    }

    /**
     * {@inheritdoc}
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        $this-&gt;startup($input, $output);

        if ($this-&gt;projectHasActiveLocales()) {
            $this-&gt;ensureFolderStructure();
            $this-&gt;saveStringToLocales();

        } else {
            $this-&gt;output-&gt;writeln(&quot;This project has no configured locale.&quot;);
        }

        $this-&gt;nl();

        $this-&gt;shutdown();
    }

    protected function getLocales()
    {
        return Strata::app()-&gt;i18n-&gt;getLocales();
    }

    protected function projectHasActiveLocales()
    {
        return Strata::app()-&gt;i18n-&gt;hasActiveLocales();
    }

    private function ensureFolderStructure()
    {
        $localeDir = Strata::getLocalePath();
        if (!is_dir($localeDir)) {
            mkdir($localeDir);
        }
    }

    private function saveStringToLocales()
    {
        $tanslation = $this-&gt;extractGettextStrings();

        foreach ($this-&gt;getLocales() as $locale) {
            $this-&gt;saveStringToLocale($locale, $tanslation);
        }
    }

    private function saveStringToLocale(Locale $locale, Translations $translation)
    {
        $poFilename = $locale-&gt;getPoFilePath();

        // Merge with an existing .po
        if ($locale-&gt;hasPoFile()) {
            $poTranslations = Translations::fromPoFile($poFilename);
            $translation-&gt;mergeWith($poTranslations);
        }

        $app = Strata::app();
        $configValue = $app-&gt;getConfig(&quot;i18n.textdomain&quot;);
        $textDomain = is_null($configValue) ? I18n::DOMAIN : $configValue;

        $translation-&gt;setDomain($textDomain);
        $translation-&gt;setHeader('Text Domain', $textDomain);

        $translation-&gt;toPoFile($poFilename);
        $translation-&gt;toMoFile($locale-&gt;getMoFilePath());
    }

    private function extractGettextStrings()
    {
        $translation = null;
        $translationObjects = array();
        $lookupDirectories = array(
            Strata::getVendorPath() . 'francoisfaubert' . DIRECTORY_SEPARATOR . 'strata' . DIRECTORY_SEPARATOR . 'src',
            Strata::getSrcPath(),
            Strata::getThemesPath(),
        );

        foreach ($lookupDirectories as $directory) {
            $translationObjects = $this-&gt;recurseThroughDirectory($directory);
        }

        // Merge all translation objects into a bigger one
        foreach ($translationObjects as $t) {
            if (is_null($translation)) {
                $translation = $t;
            } else {
                $translation-&gt;mergeWith($t);
            }
        }

        return $translation;
    }

    private function recurseThroughDirectory($baseDir, $lookingFor = &quot;/(.*)\.php$/i&quot;)
    {
        $results = array();
        $di = new RecursiveDirectoryIterator($baseDir);

        $this-&gt;output-&gt;writeLn(&quot;Scanning $baseDir...&quot;);

        foreach (new RecursiveIteratorIterator($di) as $filename =&gt; $file) {
            if (preg_match($lookingFor, $filename)) {
                $results[] = $this-&gt;extractFrom($filename);
            }
        }

        return $results;
    }

    private function extractFrom($filename)
    {
        return WpCode::fromFile($filename);
    }

}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>