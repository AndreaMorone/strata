<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
namespace Strata\Shell\Command;

use Strata\Shell\Command\StrataCommand;

use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputArgument;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;
use InvalidArgumentException;

/**
 * Automates Strata self-maintaining scripts.
 *
 * Intended use include:
 *     &lt;code&gt;bin/strata strata install&lt;/code&gt;
 *     &lt;code&gt;bin/strata strata uninstall&lt;/code&gt;
 */
class EnvCommand extends StrataCommand
{
    /**
     * A flag that is maintain through a process to advise the
     * user should something happen.
     *
     * @var boolean
     */
    protected $_seemsFine = true;

    /**
     * Strata's directory structure
     *
     * @var array
     */
    protected $_directoryStructure = array(
        &quot;bin&quot;,
        &quot;config&quot;,
        &quot;db&quot;,
        &quot;doc&quot;,
        &quot;log&quot;,
        &quot;src&quot;,
        &quot;src/Controller&quot;,
        &quot;src/Model&quot;,
        &quot;src/Model/Validator&quot;,
        &quot;src/View&quot;,
        &quot;src/View/helper&quot;,
        &quot;test&quot;,
        &quot;test/Controller&quot;,
        &quot;test/Model&quot;,
        &quot;test/Model/Validator&quot;,
        &quot;test/View&quot;,
        &quot;test/View/Helper&quot;,
        &quot;test/Fixture&quot;,
        &quot;test/Fixture/Wordpress&quot;,
        &quot;tmp&quot;
    );

    /**
     * The source URL for stater app files
     *
     * @todo This needs to be a composer dependency.
     * @var string
     */
    protected $_srcUrl = &quot;https://raw.githubusercontent.com/francoisfaubert/strata-env/master/&quot;;

    /**
     * Strata's empty project files and their destination.
     *
     * @var array
     */
    protected $_starterFiles = array(
        'src/Controller/AppController.php' =&gt; 'src/Controller/AppController.php',
        'src/Model/AppModel.php'      =&gt; 'src/Model/AppModel.php',
        'src/Model/AppCustomPostType.php'      =&gt; 'src/Model/AppCustomPostType.php',
        'src/View/Helper/AppHelper.php'     =&gt; 'src/View/Helper/AppHelper.php',
        'config/strata.php'        =&gt; 'config/strata.php',
        'web/app/mu-plugins/strata-bootstraper.php'        =&gt; 'web/app/mu-plugins/strata-bootstraper.php',
        'test/strata-test-bootstraper.php'   =&gt; 'test/strata-test-bootstraper.php',
        'test/Fixture/Wordpress/wordpress-bootstraper.php'     =&gt; 'test/Fixture/Wordpress/wordpress-bootstraper.php',
    );

    /**
     * {@inheritdoc}
     */
    protected function configure()
    {
        $this
            -&gt;setName('env')
            -&gt;setDescription('Manages the Strata installation.')
            -&gt;addArgument(
                'mode',
                InputArgument::REQUIRED,
                'repair'
            );
    }

    /**
     * {@inheritdoc}
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        $this-&gt;startup($input, $output);

        switch ($input-&gt;getArgument('mode')) {
            case &quot;repair&quot;:
                $this-&gt;repair();
                break;
            default : throw new InvalidArgumentException(&quot;That is not a valid command.&quot;);
        }

        $this-&gt;shutdown();
    }

    /**
     * Installs Strata files and directories
     * @return null
     */
    protected function repair()
    {
        $this-&gt;createDirectoryStructure();
        $this-&gt;createStarterFiles();
        $this-&gt;installDone();
    }

    /**
     * Creates the directory structure. Does not overwrite existing
     * directories.
     * @return null
     */
    protected function createDirectoryStructure()
    {
        $this-&gt;output-&gt;writeLn(&quot;Ensuring correct directory structure.&quot;);

        $count = 0;
        foreach ($this-&gt;_directoryStructure as $dir) {
            $label = $this-&gt;tree(++$count &gt;= count($this-&gt;_directoryStructure));
            if (!is_dir($dir)) {
                if (mkdir($dir)) {
                    $this-&gt;output-&gt;writeLn($label . $this-&gt;ok($dir));
                } else {
                    $this-&gt;output-&gt;writeLn($label . $this-&gt;fail($dir));
                    $this-&gt;flagFailing();
                }
            } else {
                $this-&gt;output-&gt;writeLn($label . $this-&gt;skip($dir));
            }
        }

        $this-&gt;nl();
    }


    /**
     * Adds the starter file to a new project. Does not overwrite existing
     * files.
     * @return null
     */
    protected function createStarterFiles()
    {
        $this-&gt;output-&gt;writeLn(&quot;Ensuring project files are present.&quot;);

        $count = 0;
        foreach ($this-&gt;_starterFiles as $source =&gt; $file) {
            $label = $this-&gt;tree(++$count &gt;= count($this-&gt;_starterFiles));
            if (!file_exists($file)) {
                if (file_put_contents($file, fopen($this-&gt;_srcUrl . $source, 'r')) &gt; 0) {
                    $this-&gt;output-&gt;writeLn($label . $this-&gt;ok($file));
                } else {
                    $this-&gt;output-&gt;writeLn($label . $this-&gt;fail($file));
                    $this-&gt;flagFailing();
                }
            } else {
                $this-&gt;output-&gt;writeLn($label . $this-&gt;skip($file));
            }
        }

        $this-&gt;nl();
    }


    protected function _getPhpunit()
    {
        $file = &quot;bin/phpunit.phar&quot;;
        $label = $this-&gt;tree(true);
        $this-&gt;output-&gt;writeLn(&quot;Fetching PHPUnit&quot;);

         if (!file_exists($file)) {
            if (file_put_contents($file, fopen(&quot;https://phar.phpunit.de/phpunit.phar&quot;, 'r')) &gt; 0) {
                $this-&gt;output-&gt;writeLn($label . $this-&gt;ok($file));
            } else {
                $this-&gt;output-&gt;writeLn($label . $this-&gt;fail($file));
                $this-&gt;flagFailing();
            }
        } else {
            $this-&gt;output-&gt;writeLn($label . $this-&gt;skip($file));
        }

        $this-&gt;nl();
    }


    /**
     * Flag the current process is not behaving as we expected.
     * @return null
     */
    protected function flagFailing()
    {
        $this-&gt;_seemsFine = false;
    }


    /**
     * Presents a summary of the operation to the user.
     * @return
     */
    protected function installDone()
    {
        $this-&gt;nl();
        if ($this-&gt;_seemsFine) {
            $this-&gt;output-&gt;writeLn(&quot;========================================================================&quot;);
            $this-&gt;nl();
            $this-&gt;output-&gt;writeLn(&quot;                      Repair completed!&quot;);
            $this-&gt;nl();
            $this-&gt;output-&gt;writeLn(&quot;========================================================================&quot;);
        } else {
            $this-&gt;output-&gt;writeLn(&quot;Automatic installation failed to complete cleanly.&quot;);
            $this-&gt;output-&gt;writeLn(&quot;Head over to https://github.com/francoisfaubert/strata/ to get help.&quot;);
        }
        $this-&gt;nl();
    }
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>