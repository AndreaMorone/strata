<html>
    <head>
        <script
            type="text/javascript"
            src="../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
namespace Strata;

use Strata\Logger\Logger;
use Strata\Router\Router;
use Strata\Utility\Hash;

use Strata\Core\StrataContext;
use Strata\Core\StrataConfigurableTrait;

use Strata\Model\CustomPostType\CustomPostTypeLoader;
use Strata\Middleware\MiddlewareLoader;
use Strata\Security\Security;

use Composer\Autoload\ClassLoader;
use Exception;

/**
 * Running Strata instance
 *
 * @package       Strata
 * @link          http://strata.francoisfaubert.com/docs/
 */
class Strata extends StrataContext {

    use StrataConfigurableTrait;

    /**
     * @var bool Specifies the requirements have been met from the current configuration
     */
    protected $ready = false;

    /**
     * @var \Composer\Autoload\ClassLoader Keeps a reference to the current project's Composer autoloader file.
     */
    protected $loader = null;

    protected $logger = null;
    private $middlewareLoader = null;

    public $i18n = null;
    public $router = null;

    /**
     * Prepares the object for its run.
     * @throws \Exception Throws an exception if the configuration array could not be loaded.
     */
    public function init()
    {
        $this-&gt;ready = false;

        $this-&gt;configureLogger();
        $this-&gt;includeUtils();
        $this-&gt;loadConfiguration();
        $this-&gt;setTimeZone();

        $this-&gt;localize();
        $this-&gt;middlewareLoader = new MiddlewareLoader($this-&gt;getLoader());

        $this-&gt;ready = true;
    }

    /**
     * Kickstarts the router and preload the custom post types associated to the project.
     */
    public function run()
    {
        if (!$this-&gt;ready) {
            $this-&gt;init();
        }

        $this-&gt;configureRouter();
        $this-&gt;configureCustomPostType();
        $this-&gt;addAppRoutes();
        $this-&gt;loadMiddleware();
        $this-&gt;improveSecurity();
    }

    public function loadConfiguration()
    {
        $this-&gt;saveConfigurationFileSettings(self::parseProjectConfigFile());

        if (!$this-&gt;containsConfigurations()) {
            throw new Exception(&quot;Using the Strata bootstraper requires a file named 'config/strata.php' that declares a configuration array named \$strata.&quot;);
        }

        $this-&gt;addProjectNamespace();
    }


    /**
     * Assigns a class loader to the application
     * @param ClassLoader $loader The application's class loader.
     */
    public function setLoader(ClassLoader $loader)
    {
        $this-&gt;loader = $loader;
    }

    /**
     * Returns a class loader to the application
     * @return ClassLoader $loader The application's class loader.
     */
    public function getLoader()
    {
        return $this-&gt;loader;
    }

    /**
     * Looks through all the packages in composer and if they
     * are in our Strata\Middleware namespace, we try to autoload them.
     */
    protected function loadMiddleware()
    {
        if (!is_null($this-&gt;middlewareLoader)) {
            $this-&gt;middlewareLoader-&gt;initialize();
        }
    }

    public function getMiddlewares()
    {
        return $this-&gt;middlewareLoader-&gt;getMiddlewares();
    }

    protected function configureLogger()
    {
        $this-&gt;logger = new Logger();
    }

    public function log($message, $context = &quot;[Strata]&quot;)
    {
        if (!is_null($this-&gt;logger)) {
            return $this-&gt;logger-&gt;log($message, $context);
        }
    }

    protected function localize()
    {
        $this-&gt;i18n = new I18n\I18n();
        $this-&gt;i18n-&gt;initialize();
    }

    /**
     * Configures the default router object to ensure that URL mapping
     * is automated.
     * @return null
     */
    protected function configureRouter()
    {
        $this-&gt;router = Router::urlRouting();
    }

    protected function addAppRoutes()
    {
        $routes = $this-&gt;getConfig('routes');
        if (is_array($routes)) {
            $this-&gt;router-&gt;addRoutes($routes);
        }
    }

    /**
     * Configures the post type loader
     * is automated.
     * @return null
     */
    protected function configureCustomPostType()
    {
        $loader = new CustomPostTypeLoader();
        $loader-&gt;configure((array)$this-&gt;getConfig('custom-post-types'));
        $loader-&gt;load();
    }

    /**
     * Saves an array of options to the configuration attribute.
     * @param  array $values A list of project values.
     * @return null
     */
    protected function saveConfigurationFileSettings($values = array())
    {
        if (count($values) &gt; 0) {
            $this-&gt;configure($values);
            $this-&gt;normalizeConfiguration();
        }
    }

    /**
     * Includes the debugger classes.
     * @return boolean True if the file was correctly included.
     */
    protected function includeUtils()
    {
        return $this-&gt;saveCurrentPID() &amp;&amp; $this-&gt;includeDebug();
    }

    /**
     * Save the latest PHP process ID as a temp file in case an infinite loop
     * or any unexpected error breaks the server, but doesn't close it.
     */
    protected function saveCurrentPID()
    {
        $pid = getmypid();

        if (!self::isCommandLineInterface()) {
            $this-&gt;log(&quot;&quot;, sprintf(&quot;[Strata] Loaded and running with process ID %s&quot;, $pid));
        }

        $filename = self::getTmpPath() . &quot;pid&quot;;
        return @file_put_contents($filename, $pid);
    }

    protected function includeDebug()
    {
        $debug = self::getUtilityPath() . &quot;Debug.php&quot;;

        if (file_exists($debug)) {
            return include_once($debug);
        }
    }

    /**
     * Adds the current project namespace to the project's class loader.
     * @return null
     */
    protected function addProjectNamespace()
    {
        $srcPath = self::getSRCPath();
        $namespace = self::getNamespace() . &quot;\\&quot;;

        $this-&gt;loader-&gt;setPsr4($namespace, $srcPath);
    }

    protected function setTimeZone()
    {
        $timezone = Strata::app()-&gt;getConfig(&quot;timezone&quot;);
        if (is_null($timezone)) {
            $timezone = 'America/New_York';
        }
        date_default_timezone_set($timezone);
    }

    protected function improveSecurity()
    {
        $security = new Security();
        $security-&gt;addMesures();
    }
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>