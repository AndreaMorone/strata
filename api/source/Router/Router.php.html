<html>
    <head>
        <script
            type="text/javascript"
            src="../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
namespace Strata\Router;

use Exception;

use Strata\Strata;
use Strata\Router\RouteParser\Alto\AltoRouteParser;
use Strata\Router\RouteParser\Callback\CallbackRouter;

/**
 * Assigns callback handlers on demand and from the URL context.
 *
 * @package       Strata.Router
 * @link          http://strata.francoisfaubert.com/docs/routes/
 */
class Router {

    /**
     * @var Strata\Router\RouteParser\Route A route that this object will try to execute
     */
    public $route = null;


    /**
     * Generates a dynamic and unique callback ready to use with Wordpress' add_action calls.
     * @param string $ctrl Controller class shortname
     * @param string $action
     * @return array A valid callback for call_user_func
     */
    public static function callback($ctrl, $action)
    {
        return CallbackRouter::factory($ctrl, $action);
    }

    /**
     * Generates a parser for URL based rules, as one may be used to in
     * the world of Model View Controller programming.
     * @param  array  $routes A list of available routes and callbacks
     * @return Strata\Router\RouteParser\Alto\AltoRouteParser  The parser that generates a valid route
     */
    public static function urlRouting($routes = array())
    {
        return AltoRouteParser::factory($routes);
    }

    public static function isAjax()
    {
        return defined('DOING_AJAX') &amp;&amp; DOING_AJAX;
    }

    // @thanks to https://snippets.khromov.se/determine-if-wordpress-ajax-request-is-a-backend-of-frontend-request/
    public static function isFrontendAjax()
    {

        if(self::isAjax()) {
              $referer = '';
              $filename = isset($_SERVER['SCRIPT_FILENAME']) ? $_SERVER['SCRIPT_FILENAME'] : '';

              if (!empty($_REQUEST['_wp_http_referer'])) {
                  $referer = wp_unslash( $_REQUEST['_wp_http_referer'] );
              } elseif(!empty($_SERVER['HTTP_REFERER'])) {
                  $referer = wp_unslash($_SERVER['HTTP_REFERER']);
              }

              return strpos($referer, admin_url()) === false &amp;&amp; basename($filename) === 'admin-ajax.php';
        }

        return false;
    }

    /**
     * Attemps to run the currently loaded route object.
     * @return mixed Returns what the action function will have returned.
     * @throws  Exception when the route is not instantiated.
     */
    public function run($url = null)
    {
        if (is_null($this-&gt;route)) {
            throw new Exception(&quot;This is an invalid route.&quot;);
        }

        // Allow plugins and code outside the MVC to cancel
        // a route.
        if (function_exists('apply_filters')) {
          $url = apply_filters('strata_on_before_url_routing', $url);
        }

        $this-&gt;route-&gt;process($url);

        if ($this-&gt;route-&gt;isValid()) {
            return $this-&gt;loopCurrentRequest();
        }

        $this-&gt;log(sprintf(&quot;%s#%s is not a matched Strata route.&quot;, get_class($this-&gt;route-&gt;controller), $this-&gt;route-&gt;action));
    }

    public function abandonCurrent()
    {
        $this-&gt;route-&gt;cancel();
    }

    private function loopCurrentRequest()
    {
        while (!$this-&gt;route-&gt;isCancelled()) {

            $this-&gt;route-&gt;start();

            $this-&gt;route-&gt;controller-&gt;init();
            $this-&gt;route-&gt;controller-&gt;before();

            $returnData = call_user_func_array(array($this-&gt;route-&gt;controller, $this-&gt;route-&gt;action), $this-&gt;route-&gt;arguments);

            $this-&gt;route-&gt;controller-&gt;after();
            $this-&gt;route-&gt;end();

            return $returnData;
        }
    }

    private function log($msg, $type = &quot;[Strata:Router]&quot;)
    {
        $app = Strata::app();
        $app-&gt;log($msg, $type);
    }
}


</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>